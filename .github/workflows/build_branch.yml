name: Build branch
on:
  workflow_dispatch:

jobs:
  publish-wails:
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [windows-latest, ubuntu-latest]

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v3

      - name: setup bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Build wails embed (Windows)
        if: matrix.platform == 'windows-latest'
        uses: dAppServer/wails-build-action@756cb1ac7fe5611f1e3bac6f0d83225ff9e87421
        with:
          package: false
          go-version: '1.23.1'
          build-name: spt-give-ui-embed.exe
          build-platform: windows/amd64
          wails-build-webview2: embed

      - name: Build wails embed (Linux)
        if: matrix.platform == 'ubuntu-latest'
        uses: dAppServer/wails-build-action@756cb1ac7fe5611f1e3bac6f0d83225ff9e87421
        with:
          package: false
          build-tags: 'webkit2_41'
          go-version: '1.23.1'
          build-name: spt-give-ui-embed
          build-platform: linux/amd64
          wails-build-webview2: embed

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0

      - name: Build .NET project
        run: dotnet build --configuration Release ./server-mod/GiveUISolution.sln

      # Windows packaging
      - name: Package zip (Windows)
        if: matrix.platform == 'windows-latest'
        run: |
          mkdir "dist/SPT/user/mods/give-ui-${{ github.sha }}"
          mv ./server-mod/GiveUI/bin/Release/net9.0/GiveUI.dll ./dist/SPT/user/mods/give-ui-${{ github.sha }}/GiveUI.dll
          mv ./build/bin/spt-give-ui-embed.exe ./dist/SPT/user/mods/give-ui-${{ github.sha }}/give-ui-${{ github.sha }}_x64-portable.exe
          Compress-Archive -Path ./dist/* -Destination ./give-ui-${{ github.sha }}-windows.zip

      # Linux packaging
      - name: Package zip (Linux)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          mkdir -p "dist/SPT/user/mods/give-ui-${{ github.sha }}"
          mv ./server-mod/GiveUI/bin/Release/net9.0/GiveUI.dll ./dist/SPT/user/mods/give-ui-${{ github.sha }}/GiveUI.dll
          mv ./build/bin/spt-give-ui-embed ./dist/SPT/user/mods/give-ui-${{ github.sha }}/give-ui-${{ github.sha }}_x64-portable
          cd dist
          zip -r ../give-ui-${{ github.sha }}-linux.zip .

      - uses: actions/upload-artifact@v4
        with:
          name: give-ui-${{ matrix.platform }}
          path: ./give-ui-${{ github.sha }}-*.zip
